#!/bin/bash
#
# this script will deploy the app to the given foundry URL and space
# Configuration is given by ENV variable
# CF_FOUNDRY_API: hostname for API login
# CF_USER: space deployer username
# CF_PASSWORD_NAME: name of ENV variable holding space deployer password
# CF_SPACE: space to deploy to
# VARS_FILE: filename for variables
# RAILS_MASTER_KEY_NAME: name of ENV variable holding key to decrypt the credentials file(s)

# exit the script if either step fails
set -e

# login to the given foundry, and target the correct space
cf login -a $CF_FOUNDRY_API -u $CF_USER -p ${!CF_PASSWORD_NAME} -o tts-usps-test-at-home -s $CF_SPACE

# do the deploy
cf push --strategy rolling --vars-file $VARS_FILE --var rails_master_key=${!RAILS_MASTER_KEY_NAME}
